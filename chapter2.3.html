<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Avalanche网络</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="chapter1.html"><strong aria-hidden="true">1.</strong> 第一章 Avalanche共识协议介绍</a></li><li class="chapter-item expanded "><a href="chapter2.html"><strong aria-hidden="true">2.</strong> 第二章 AvalancheGo结构分析</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="chapter2.1.html"><strong aria-hidden="true">2.1.</strong> snowman协议</a></li><li class="chapter-item expanded "><a href="chapter2.2.html"><strong aria-hidden="true">2.2.</strong> snowman协议实现解析</a></li><li class="chapter-item expanded "><a href="chapter2.3.html" class="active"><strong aria-hidden="true">2.3.</strong> Avalanche网络</a></li></ol></li><li class="chapter-item expanded "><a href="chapter3.html"><strong aria-hidden="true">3.</strong> 第三章 VM与AvalancheGo的连接</a></li><li class="chapter-item expanded "><a href="chapter4.html"><strong aria-hidden="true">4.</strong> 第四章 创建虚拟机VM</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="chapter4.1.html"><strong aria-hidden="true">4.1.</strong> 时间戳服务器的实现Virtual Machine</a></li><li class="chapter-item expanded "><a href="chapter4.2.html"><strong aria-hidden="true">4.2.</strong> Static API</a></li><li class="chapter-item expanded "><a href="chapter4.3.html"><strong aria-hidden="true">4.3.</strong> API</a></li><li class="chapter-item expanded "><a href="chapter4.4.html"><strong aria-hidden="true">4.4.</strong> 封装运行</a></li></ol></li><li class="chapter-item expanded "><a href="chapter5.html"><strong aria-hidden="true">5.</strong> 第五章 专用EVM开发</a></li><li class="chapter-item expanded "><a href="chapter6.html"><strong aria-hidden="true">6.</strong> 第六章 本地网络模拟ANR</a></li><li class="chapter-item expanded "><a href="chapter7.html"><strong aria-hidden="true">7.</strong> 第七章 本地调试</a></li><li class="chapter-item expanded "><a href="chapter8.html"><strong aria-hidden="true">8.</strong> 第八章 生产环境部署</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="avalanche网络"><a class="header" href="#avalanche网络">Avalanche网络</a></h1>
<h2 id="目录"><a class="header" href="#目录">目录</a></h2>
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#peers">Peers</a>
<ul>
<li><a href="#lifecycle">Lifecycle</a>
<ul>
<li><a href="#bootstrapping">Bootstrapping</a></li>
<li><a href="#connecting">Connecting</a>
<ul>
<li><a href="#peer-handshake">Peer Handshake</a></li>
</ul>
</li>
<li><a href="#connected">Connected</a>
<ul>
<li><a href="#peerlist-gossip">PeerList Gossip</a>
<ul>
<li><a href="#messages">Messages</a></li>
<li><a href="#gossip">Gossip</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="概览"><a class="header" href="#概览">概览</a></h2>
<p>Avalanche is a decentralized <a href="https://en.wikipedia.org/wiki/Peer-to-peer">p2p</a> (peer-to-peer) network of nodes that work together to run the Avalanche blockchain protocol.</p>
<p>The <code>network</code> package implements the networking layer of the protocol which allows a node to discover, connect to, and communicate with other peers.</p>
<h2 id="peers节点"><a class="header" href="#peers节点">Peers节点</a></h2>
<p>Peers节点是构成Avlanche网络的基本网络节点，所有节点之间可以相互通信，并参与Avalanche共识协议。</p>
<p>每一个Peers节点与其他各个节点之间的通讯是异步的，类似队列的先进先出顺序，即与一个节点完成通讯之后才会处理与其他节点之间的通信。以这种特殊方式处理通讯是因为Avalanche共识协议的工作原理导致的。 
节点之间通信的消息Messages包括App层的messages和网络层的messsages。app层messages主要用于达成Avalanche协议，网络层messages主要用于实现点对点通信层。 </p>
<pre><code class="language-mermaid">sequenceDiagram
    loop 
        Peer-1-&gt;&gt;Peer-2: Write outbound messages
        Peer-2-&gt;&gt;Peer-1: Read incoming messages
    end
    loop
        Peer-2-&gt;&gt;Peer-1: Write outbound messages
        Peer-1-&gt;&gt;Peer-2: Read incoming messages
    end
</code></pre>
<h3 id="lifecycle"><a class="header" href="#lifecycle">Lifecycle</a></h3>
<h4 id="启动节点"><a class="header" href="#启动节点">启动节点</a></h4>
<p>When starting an Avalanche node, a node needs to be able to initiate some process that eventually allows itself to become a participating member of the network. In traditional web2 systems, it's common to use a web service by hitting the service's DNS and being routed to an available server behind a load balancer. In decentralized p2p systems however, connecting to a node is more complex as no single entity owns the network. <a href="https://docs.avax.network/overview/getting-started/avalanche-consensus">Avalanche consensus</a> requires a node to repeatedly sample peers in the network, so each node needs some way of discovering and connecting to every other peer to participate in the protocol.</p>
<p>In Avalanche, nodes connect to an initial set of bootstrapper nodes known as <strong>beacons</strong> (this is user-configurable). Once connected to a set of beacons, a node is able to discover other nodes in the network. Over time, a node eventually discovers other peers in the network through <code>PeerList</code> messages it receives through:</p>
<ul>
<li>The handshake initiated between two peers when attempting to connect to a peer (see <a href="#connecting">Connecting</a>).</li>
<li>Periodic <code>PeerList</code> gossip messages that every peer sends to the peers it's connected to (see <a href="#connected">Connected</a>).</li>
</ul>
<h4 id="connecting"><a class="header" href="#connecting">Connecting</a></h4>
<h5 id="peer-handshake"><a class="header" href="#peer-handshake">Peer Handshake</a></h5>
<p>一连上某一个节点，连个节点之间就执行握手程序handshake，建立一个发送连接和接收连接。
Upon connection to any peer, a handshake is performed between the node attempting to establish the outbound connection to the peer and the peer receiving the inbound connection.</p>
<p>当尝试建立起连接时，第一个message为&quot;Version&quot;message,主要描述candidate node和本节点之间的compatibility.
When attempting to establish the connection, the first message that the node attempting to connect to the peer in the network is a <code>Version</code> message describing compatibility of the candidate node with the peer. As an example, nodes that are attempting to connect with an incompatible version of AvalancheGo or a significantly skewed local clock are rejected by the peer.</p>
<pre><code class="language-mermaid">sequenceDiagram
Note over Node,Peer: Initiate Handshake
Note left of Node: I want to connect to you!
Note over Node,Peer: Version message
Node-&gt;&gt;Peer: AvalancheGo v1.0.0
Note right of Peer: My version v1.9.4 is incompatible with your version v1.0.0.
Peer-xNode: Connection dropped
Note over Node,Peer: Handshake Failed
</code></pre>
<p>If the <code>Version</code> message is successfully received and the peer decides that it wants a connection with this node, it replies with a <code>PeerList</code> message that contains metadata about other peers that allows a node to connect to them. Upon reception of a <code>PeerList</code> message, a node will attempt to connect to any peers that the node is not already connected to to allow the node to discover more peers in the network.</p>
<pre><code class="language-mermaid">sequenceDiagram
Note over Node,Peer: Initiate Handshake
Note left of Node: I want to connect to you!
Note over Node,Peer: Version message
Node-&gt;&gt;Peer: AvalancheGo v1.9.4
Note right of Peer: LGTM!
Note over Node,Peer: PeerList message
Peer-&gt;&gt;Node: Peer-X, Peer-Y, Peer-Z
Note over Node,Peer: Handshake Complete
Node-&gt;&gt;Peer: ACK Peer-X, Peer-Y, Peer-Z
</code></pre>
<p>Once the node attempting to join the network receives this <code>PeerList</code> message, the handshake is complete and the node is now connected to the peer. The node attempts to connect to the new peers discovered in the <code>PeerList</code> message. Each connection results in another peer handshake, which results in the node incrementally discovering more and more peers in the network as more and more <code>PeerList</code> messages are exchanged.</p>
<h4 id="connected"><a class="header" href="#connected">Connected</a></h4>
<p>Some peers aren't discovered through the <code>PeerList</code> messages exchanged through peer handshakes. This can happen if a peer is either not randomly sampled, or if a new peer joins the network after the node has already connected to the network.</p>
<pre><code class="language-mermaid">sequenceDiagram
Node -&gt;&gt; Peer-1: Version - v1.9.5
Peer-1 -&gt;&gt; Node: PeerList - Peer-2
Node -&gt;&gt; Peer-1: ACK - Peer-2
Note left of Node: Node is connected to Peer-1 and now tries to connect to Peer-2.
Node -&gt;&gt; Peer-2: Version - v1.9.5
Peer-2 -&gt;&gt; Node: PeerList - Peer-1
Node -&gt;&gt; Peer-2: ACK - Peer-1
Note left of Node: Peer-3 was never sampled, so we haven't connected yet!
Node --&gt; Peer-3: No connection
</code></pre>
<p>为保证节点能够发现整个网络的其他所有的节点，每一个节点都会在已知的节点中随机取样部分节点进行periodiclly gossips。 
To guarantee that a node can discover all peers, each node periodically gossips a sample of the peers it knows about to other peers.</p>
<h5 id="peerlist-gossip"><a class="header" href="#peerlist-gossip">PeerList Gossip</a></h5>
<h6 id="messages"><a class="header" href="#messages">Messages</a></h6>
<p>A <code>PeerList</code> is the message that is used to communicate the presence of peers in the network. Each <code>PeerList</code> message contains networking-level metadata about the peer that provides the necessary information to connect to it, alongside the corresponding transaction id that added that peer to the validator set. Transaction ids are unique hashes that only add a single validator, so it is guaranteed that there is a 1:1 mapping between a validator and its associated transaction id.</p>
<p><code>PeerListAck</code> messages are sent in response to <code>PeerList</code> messages to allow a peer to confirm which peers it will actually attempt to connect to. Because nodes only gossip peers they believe another peer doesn't already know about to optimize bandwidth, <code>PeerListAck</code> messages are important to confirm that a peer will attempt to connect to someone. Without this, a node might gossip a peer to another peer and assume a connection between the two is being established, and not re-gossip the peer in future gossip cycles. If the connection was never actually wanted by the peer being gossiped to due to a transient reason, that peer would never be able to re-discover the gossiped peer and could be isolated from a subset of the network.</p>
<p>Once a <code>PeerListAck</code> message is received from a peer, the node that sent the original <code>PeerList</code> message marks the corresponding acknowledged validators as already having been transmitted to the peer, so that it's excluded from subsequent iterations of <code>PeerList</code> gossip.</p>
<h6 id="gossip-节点信息传播"><a class="header" href="#gossip-节点信息传播">Gossip 节点信息传播</a></h6>
<p>handshake messages 会给节点提供一部分网络上的节点数据，但是这种从每一个已连接的节点的handshake messages获取网络节点数据的方式不能保证能获取全网的所有节点数据。
Handshake messages provide a node with some knowledge of peers in the network, but offers no guarantee that learning about a subset of peers from each peer the node connects with will result in the node learning about every peer in the network.
为了保证节点最终能够得到全网所有节点的数据（极大概率上安全保证）。每一个节点都会periodically 从已经连接的节点中随机取样部分节点进行gossips。随着时间的推移，极大概率（基本等于肯定）所有节点都会获取全网其他节点的数据。
In order to provide a probabilistic guarantee that all peers in the network will eventually learn of one another, each node periodically gossips a sample of the peers that they're aware of to a sample of the peers that they're connected to. Over time, this probabilistically guarantees that every peer will eventually learn of every other peer.
为优化网络带宽的占用，每一个节点自己都会记录、维护哪些节点一定“知道”哪些其他节点，节点通过跟踪分析进、出“PeerList”来维护这些信息、数据。
To optimize bandwidth usage, each node tracks which peers are guaranteed to know of which peers. A node learns this information by tracking both inbound and outbound <code>PeerList</code> gossip.</p>
<ul>
<li>Inbound
<ul>
<li>如果一个节点收到其他某一个节点发来的的'PeerList'，则该节点应该知道PeerList中的节点信息，接着该节点就可以向名单中的这些节点发送Gossip.</li>
</ul>
</li>
<li>Outbound
<ul>
<li>如果一个节点向网络上其他某一个节点发送向“PeerList”，而且这个节点返回了一个‘PeerListAck’message,然后该节点又可以从PeerListAck中获取其他网络节点的信息。
节点为高效维护跟踪其他摸一个网络节点知道某一个其他网络节点的关系，每一个所有节点都知道的节点用一个<a href="https://en.wikipedia.org/wiki/Bit_array">bit set</a>来表示，一个节点如果已经被所有节点知道就表示为1、否者表示为0.</li>
</ul>
</li>
</ul>
<p>节点按照下面的流程进行每进行一轮&quot;PeerList&quot; gossip。</p>
<ol>
<li>Get a sample of peers in the network that the node is connected to</li>
<li>For each peer:
<ol>
<li>Figure out which peers the node hasn't gossiped to them yet.</li>
<li>Take a random sample of these unknown peers.</li>
<li>Send a message describing these peers to the peer.</li>
</ol>
</li>
</ol>
<pre><code class="language-mermaid">sequenceDiagram
Note left of Node: Initialize gossip bit set for Peer-123
Note left of Node: Peer-123: [0, 0, 0]
Node-&gt;&gt;Peer-123: PeerList - Peer-1
Peer-123-&gt;&gt;Node: PeerListAck - Peer-1
Note left of Node: Peer-123: [1, 0, 0]
Node-&gt;&gt;Peer-123: PeerList - Peer-3
Peer-123-&gt;&gt;Node: PeerListAck - Peer-3
Note left of Node: Peer-123: [1, 0, 1]
Node-&gt;&gt;Peer-123: PeerList - Peer-2
Peer-123-&gt;&gt;Node: PeerListAck - Peer-2
Note left of Node: Peer-123: [1, 1, 1]
Note left of Node: No more gossip left to send to Peer-123!
</code></pre>
<p>假设整个网络的状态是稳定的（通过质押来回报来保证），没有连续连接/断开的网络节点。随着gossip messages的传播，最终节点就会发现，与其连接的节点都已经得到了所有的全网络的其他节点的信息数据。</p>
<p>节点最终也会停止gossiping,当没有新的节点需要与其他节点gossip的时候。<code>PeerList</code> gossip只会在以下的情况下在次运行：</p>
<ol>
<li>有一个新节点加入。</li>
<li>有一个节点断开连接和重新连接。</li>
<li>有新的验证节点加入共识网络。</li>
<li>验证节点IP更新。</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="chapter2.2.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="chapter3.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="chapter2.2.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="chapter3.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
