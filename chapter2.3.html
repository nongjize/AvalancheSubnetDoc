<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Avalanche网络</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="chapter1.html"><strong aria-hidden="true">1.</strong> 第一章 Avalanche共识协议介绍</a></li><li class="chapter-item expanded "><a href="chapter2.html"><strong aria-hidden="true">2.</strong> 第二章 AvalancheGo结构分析</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="chapter2.1.html"><strong aria-hidden="true">2.1.</strong> snowman协议</a></li><li class="chapter-item expanded "><a href="chapter2.2.html"><strong aria-hidden="true">2.2.</strong> snowman协议实现解析</a></li><li class="chapter-item expanded "><a href="chapter2.3.html" class="active"><strong aria-hidden="true">2.3.</strong> Avalanche网络</a></li><li class="chapter-item expanded "><a href="SnowmanVMs.html"><strong aria-hidden="true">2.4.</strong> Snowman VMs</a></li></ol></li><li class="chapter-item expanded "><a href="chapter3.html"><strong aria-hidden="true">3.</strong> 第三章 VM与AvalancheGo的连接</a></li><li class="chapter-item expanded "><a href="chapter4.html"><strong aria-hidden="true">4.</strong> 第四章 创建虚拟机VM</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="chapter4.1.html"><strong aria-hidden="true">4.1.</strong> 时间戳服务器的实现Virtual Machine</a></li><li class="chapter-item expanded "><a href="chapter4.2.html"><strong aria-hidden="true">4.2.</strong> Static API</a></li><li class="chapter-item expanded "><a href="chapter4.3.html"><strong aria-hidden="true">4.3.</strong> API</a></li><li class="chapter-item expanded "><a href="chapter4.4.html"><strong aria-hidden="true">4.4.</strong> 封装运行</a></li></ol></li><li class="chapter-item expanded "><a href="chapter5.html"><strong aria-hidden="true">5.</strong> 第五章 专用EVM开发</a></li><li class="chapter-item expanded "><a href="chapter6.html"><strong aria-hidden="true">6.</strong> 第六章 本地网络模拟ANR</a></li><li class="chapter-item expanded "><a href="chapter7.html"><strong aria-hidden="true">7.</strong> 第七章 本地调试</a></li><li class="chapter-item expanded "><a href="chapter8.html"><strong aria-hidden="true">8.</strong> 第八章 生产环境部署</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="avalanche网络"><a class="header" href="#avalanche网络">Avalanche网络</a></h1>
<h2 id="目录"><a class="header" href="#目录">目录</a></h2>
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#peers">Peers</a>
<ul>
<li><a href="#lifecycle">Lifecycle</a>
<ul>
<li><a href="#bootstrapping">Bootstrapping</a></li>
<li><a href="#connecting">Connecting</a>
<ul>
<li><a href="#peer-handshake">Peer Handshake</a></li>
</ul>
</li>
<li><a href="#connected">Connected</a>
<ul>
<li><a href="#peerlist-gossip">PeerList Gossip</a>
<ul>
<li><a href="#messages">Messages</a></li>
<li><a href="#gossip">Gossip</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="概览"><a class="header" href="#概览">概览</a></h2>
<p>Avalanche是一个由<a href="https://en.wikipedia.org/wiki/Peer-to-peer">p2p</a> (peer-to-peer)网络节点的共同运行Avalanche区块链协议的区中心化共识网络。
<code>network</code>package 实现了协议的网络层，节点通过网络层查找到网络的其他节点，并与其他节点连接，网络节点之间通过网络层相互通信、达成共识。</p>
<h2 id="peers节点"><a class="header" href="#peers节点">Peers节点</a></h2>
<p>Peers节点是构成Avlanche网络的基本网络节点，所有节点之间可以相互通信，并参与Avalanche共识协议。</p>
<p>每一个Peers节点与其他各个节点之间的通讯是异步的，类似队列的先进先出顺序，即与一个节点完成通讯之后才会处理与其他节点之间的通信。以这种特殊方式处理通讯是因为Avalanche共识协议的工作原理导致的。 
节点之间通信的消息Messages包括App层的messages和网络层的messsages。app层messages主要用于达成Avalanche协议，网络层messages主要用于实现点对点通信层。 </p>
<pre><code class="language-mermaid">sequenceDiagram
    loop 
        Peer-1-&gt;&gt;Peer-2: Write outbound messages
        Peer-2-&gt;&gt;Peer-1: Read incoming messages
    end
    loop
        Peer-2-&gt;&gt;Peer-1: Write outbound messages
        Peer-1-&gt;&gt;Peer-2: Read incoming messages
    end
</code></pre>
<h3 id="lifecycle"><a class="header" href="#lifecycle">Lifecycle</a></h3>
<h4 id="启动节点"><a class="header" href="#启动节点">启动节点</a></h4>
<p>启动一个Avalanche节点的时候，节点需要初始化一系列程序，从而最终可以加入到网络中成为网络的一个节点，在传统的web2系统中，通常在一个负载均衡程序后开启一个服务即可。但是在去中心化p2p网络中,启动一个节点要相对复杂得多。因为整个网络是分散的。没有一个所谓的管理员。 <a href="https://docs.avax.network/overview/getting-started/avalanche-consensus">Avalanche consensus</a> 需要每个节点不断的从全网络节点中随机抽查一部分节点关于共识的达成情况，所以每个网络节点都需要有获取全网节点数据的能力、方法，从而参加共识协议的运行。</p>
<p>在Avalanche中，节点先连接到已初始化的一部分节点（即所谓的<strong>bencons</strong>,这是可配置的）。只要连接到一个beacons,节点就可以发现网络上的其他节点。随着时间的推移，节点通过以下方式接收到的 <code>PeerList</code> messages中最终发现网络上的节点：</p>
<ul>
<li>两个节点尝试连接时初始握手信息；(详见 <a href="#connecting">Connecting</a>).</li>
<li>每一个节点都会向他连接的节点 periodic <code>PeerList</code> gossip messages (详见 <a href="#connected">Connected</a>).</li>
</ul>
<h4 id="connecting-连接过程"><a class="header" href="#connecting-连接过程">Connecting 连接过程</a></h4>
<h5 id="peer-handshake"><a class="header" href="#peer-handshake">Peer Handshake</a></h5>
<p>一连上某一个节点，连个节点之间就执行握手程序handshake，建立一个发送连接和接收连接。</p>
<p>当尝试建立起连接时，第一个message为&quot;Version&quot;message,主要描述candidate node和本节点之间的compatibility.例如，当一个节点尝试与另一个运行不兼容版本的AvalancheGo的节点、或者明显的本地时钟对应不上的节点连接时，就会被拒绝。</p>
<pre><code class="language-mermaid">sequenceDiagram
Note over Node,Peer: Initiate Handshake
Note left of Node: I want to connect to you!
Note over Node,Peer: Version message
Node-&gt;&gt;Peer: AvalancheGo v1.0.0
Note right of Peer: My version v1.9.4 is incompatible with your version v1.0.0.
Peer-xNode: Connection dropped
Note over Node,Peer: Handshake Failed
</code></pre>
<p>如果<code>Version</code> message被成功接收，然后对方节点也准备与此节点连接的时候，他会回复一个<code>PeerList</code> message，该message中有网络上其他节点的信息，这些节点都也许连接。一接收到一个<code>PeerList</code> message，节点就会尝试去连接message中还没有与自己连接的的其他节点，这样一来，节点就会不断的发现网络上的其他节点。</p>
<pre><code class="language-mermaid">sequenceDiagram
Note over Node,Peer: Initiate Handshake
Note left of Node: I want to connect to you!
Note over Node,Peer: Version message
Node-&gt;&gt;Peer: AvalancheGo v1.9.4
Note right of Peer: LGTM!
Note over Node,Peer: PeerList message
Peer-&gt;&gt;Node: Peer-X, Peer-Y, Peer-Z
Note over Node,Peer: Handshake Complete
Node-&gt;&gt;Peer: ACK Peer-X, Peer-Y, Peer-Z
</code></pre>
<p>一个试图加入网络的节点如果接收到一个 <code>PeerList</code> message，握手程序就算完成，表示节点已经与该节点连接。如果节点想继续与<code>PeerList</code> message中的网络节点连接，重复handshake程序即可。如此下去，会有越来越多的<code>PeerList</code> messages交换，越来越多的节点被发现。</p>
<h4 id="connected-连接完成"><a class="header" href="#connected-连接完成">Connected 连接完成</a></h4>
<p>有一些节点peers可能不会通过<code>PeerList</code> messages来发现，出现这种情况的原因有可能是节点在取样的时候不是随机的情况下，在该网络已经加入到网络之后，又有新的peer加入到网络中。</p>
<pre><code class="language-mermaid">sequenceDiagram
Node -&gt;&gt; Peer-1: Version - v1.9.5
Peer-1 -&gt;&gt; Node: PeerList - Peer-2
Node -&gt;&gt; Peer-1: ACK - Peer-2
Note left of Node: Node is connected to Peer-1 and now tries to connect to Peer-2.
Node -&gt;&gt; Peer-2: Version - v1.9.5
Peer-2 -&gt;&gt; Node: PeerList - Peer-1
Node -&gt;&gt; Peer-2: ACK - Peer-1
Note left of Node: Peer-3 was never sampled, so we haven't connected yet!
Node --&gt; Peer-3: No connection
</code></pre>
<p>为保证节点能够发现整个网络的其他所有的节点，每一个节点都会在已知的节点中随机取样部分节点进行periodiclly gossips。 </p>
<h5 id="peerlist-gossip"><a class="header" href="#peerlist-gossip">PeerList Gossip</a></h5>
<h6 id="messages"><a class="header" href="#messages">Messages</a></h6>
<p><code>PeerList</code> message是一个用于发送网络上的节点的message,每个 <code>PeerList</code>message消息包含有节点的网络层元数据，这些元数据包含了关于如何与其连接的数据、相对应的该节点加入验证集交易的transaction id,交易id是一个唯一的hash,只用于将一个节点加入验证集，所以这样就可以保证transaction id与验证节点之间是一一对应的关系。</p>
<p><code>PeerListAck</code> messages 是用于回应确认收到 <code>PeerList</code> messages的messages，用来确认对方已经确保可以连接。为了优化网络带宽的使用，因为节点只会gossip他们认为另一个节点还不知道的同伴.<code>PeerListAck</code> messages非常重要，用于确认某一个节点打算连接。如果没有这一点，节点对另一个节点进行gossip后，会认为对方节点与正在打算与自己节点连接，从而在后续的gossip周期中不在重新对该节点进行gossip。如果由于某个临时的原因，被gossip的节点没有开始连接节点，那么该节点将永远无法重新发现被被gossip的该节点，从而导致与某一个网络子集脱离。</p>
<p>节点只要一收到<code>PeerListAck</code> message，就会将对方节点进行标记，后面的<code>PeerList</code> gossip就不在向该节点发送。</p>
<h6 id="gossip-节点信息传播"><a class="header" href="#gossip-节点信息传播">Gossip 节点信息传播</a></h6>
<p>handshake messages 会给节点提供一部分网络上的节点数据，但是这种从每一个已连接的节点的handshake messages获取网络节点数据的方式不能保证能获取全网的所有节点数据。</p>
<p>为了保证节点最终能够得到全网所有节点的数据（极大概率上安全保证）。每一个节点都会periodically 从已经连接的节点中随机取样部分节点进行gossips。随着时间的推移，极大概率（基本等于肯定）所有节点都会获取全网其他节点的数据。</p>
<p>为优化网络带宽的占用，每一个节点自己都会记录、维护哪些节点一定“知道”哪些其他节点，节点通过跟踪分析进、出“PeerList”来维护这些信息、数据。</p>
<ul>
<li>Inbound
<ul>
<li>如果一个节点收到其他某一个节点发来的的'PeerList'，则该节点应该知道PeerList中的节点信息，接着该节点就可以向名单中的这些节点发送Gossip.</li>
</ul>
</li>
<li>Outbound
<ul>
<li>如果一个节点向网络上其他某一个节点发送向“PeerList”，而且这个节点返回了一个‘PeerListAck’message,然后该节点又可以从PeerListAck中获取其他网络节点的信息。
节点为高效维护跟踪其他摸一个网络节点知道某一个其他网络节点的关系，每一个所有节点都知道的节点用一个<a href="https://en.wikipedia.org/wiki/Bit_array">bit set</a>来表示，一个节点如果已经被所有节点知道就表示为1、否者表示为0.</li>
</ul>
</li>
</ul>
<p>节点按照下面的流程进行每进行一轮&quot;PeerList&quot; gossip。</p>
<ol>
<li>Get a sample of peers in the network that the node is connected to</li>
<li>For each peer:
<ol>
<li>Figure out which peers the node hasn't gossiped to them yet.</li>
<li>Take a random sample of these unknown peers.</li>
<li>Send a message describing these peers to the peer.</li>
</ol>
</li>
</ol>
<pre><code class="language-mermaid">sequenceDiagram
Note left of Node: Initialize gossip bit set for Peer-123
Note left of Node: Peer-123: [0, 0, 0]
Node-&gt;&gt;Peer-123: PeerList - Peer-1
Peer-123-&gt;&gt;Node: PeerListAck - Peer-1
Note left of Node: Peer-123: [1, 0, 0]
Node-&gt;&gt;Peer-123: PeerList - Peer-3
Peer-123-&gt;&gt;Node: PeerListAck - Peer-3
Note left of Node: Peer-123: [1, 0, 1]
Node-&gt;&gt;Peer-123: PeerList - Peer-2
Peer-123-&gt;&gt;Node: PeerListAck - Peer-2
Note left of Node: Peer-123: [1, 1, 1]
Note left of Node: No more gossip left to send to Peer-123!
</code></pre>
<p>假设整个网络的状态是稳定的（通过质押来回报来保证），没有连续连接/断开的网络节点。随着gossip messages的传播，最终节点就会发现，与其连接的节点都已经得到了所有的全网络的其他节点的信息数据。</p>
<p>节点最终也会停止gossiping,当没有新的节点需要与其他节点gossip的时候。<code>PeerList</code> gossip只会在以下的情况下在次运行：</p>
<ol>
<li>有一个新节点加入。</li>
<li>有一个节点断开连接和重新连接。</li>
<li>有新的验证节点加入共识网络。</li>
<li>验证节点IP更新。</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="chapter2.2.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="SnowmanVMs.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="chapter2.2.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="SnowmanVMs.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
